{% extends "base.html" %}

{% block title %}Combined Project Report - Code Analysis{% endblock %}

{% block header_title %}📊 Complete Project Analysis{% endblock %}
{% block header_subtitle %}Combined Report for All Repositories{% endblock %}

{% block content %}
<!-- Navigation Index -->
<div class="bg-gradient-to-r from-uog-light-slate to-gray-50 p-8 rounded-xl border-l-4 border-uog-blue mb-12 print-avoid-break">
    <h2 class="text-2xl font-bold text-uog-blue mb-6 flex items-center">
        <span class="mr-3">📋</span>
        Project Index
    </h2>
    <p class="text-gray-700 mb-6">Click on any project below to jump to its detailed analysis:</p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for repo_url, project in projects.items() %}
        {% if project.success %}
        <a href="#project-{{ loop.index }}" class="block bg-white hover:bg-gray-50 p-4 rounded-lg border-l-4 border-uog-blue transition-all duration-200 hover:shadow-md">
            <h4 class="font-semibold text-uog-slate mb-2">{{ project.name }}</h4>
            <div class="text-sm text-gray-600 space-y-1">
                <p>{{ project.primary_language | title if project.primary_language else 'Unknown' }}</p>
                <div class="flex items-center space-x-2">
                    {% if project.vulnerability_summary.vulnerable_packages > 0 %}
                        <span class="inline-block px-2 py-1 bg-red-100 text-uog-burgundy text-xs rounded-full">
                            {{ project.vulnerability_summary.vulnerable_packages }} vulnerabilities
                        </span>
                    {% else %}
                        <span class="inline-block px-2 py-1 bg-green-100 text-uog-leaf text-xs rounded-full">
                            Secure
                        </span>
                    {% endif %}
                    {% if project.sentry_enabled and project.sentry_issues.past_month.total > 0 %}
                        <span class="inline-block px-2 py-1 bg-orange-100 text-uog-rust text-xs rounded-full">
                            {{ project.sentry_issues.past_month.total }} Sentry issues
                        </span>
                    {% elif project.sentry_enabled %}
                        <span class="inline-block px-2 py-1 bg-green-100 text-uog-leaf text-xs rounded-full">
                            No errors
                        </span>
                    {% endif %}
                </div>
            </div>
        </a>
        {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Executive Summary Section -->
<div class="mb-16 print-page-break">
    <h2 class="text-3xl font-bold text-uog-slate mb-8 border-l-4 border-uog-blue pl-4">
        📋 Executive Summary
    </h2>
    
    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-8">
        <div class="bg-gradient-to-br from-uog-blue to-uog-sky text-white p-6 rounded-lg text-center print-avoid-break">
            <h3 class="text-3xl font-bold mb-2">{{ summary.successful_analyses }}</h3>
            <p class="text-sm opacity-90">Projects Analyzed</p>
        </div>
        
        <div class="bg-gradient-to-br from-uog-leaf to-green-600 text-white p-6 rounded-lg text-center print-avoid-break">
            <h3 class="text-3xl font-bold mb-2">{{ summary.unique_dependency_count | default(summary.total_dependencies) }}</h3>
            <p class="text-sm opacity-90">Unique Dependencies</p>
            {% if summary.unique_dependency_count != summary.total_dependencies %}
            <p class="text-xs opacity-75">({{ summary.total_dependencies }} total usages)</p>
            {% endif %}
        </div>
        
        <div class="bg-gradient-to-br from-{% if risk_metrics.vulnerable_projects > 0 %}uog-burgundy to-red-700{% else %}uog-leaf to-green-600{% endif %} text-white p-6 rounded-lg text-center print-avoid-break">
            <h3 class="text-3xl font-bold mb-2">{{ risk_metrics.vulnerable_projects }}</h3>
            <p class="text-sm opacity-90">Projects with Vulnerabilities</p>
        </div>
        
        <div class="bg-gradient-to-br from-uog-rust to-orange-600 text-white p-6 rounded-lg text-center print-avoid-break">
            <h3 class="text-3xl font-bold mb-2">{{ risk_metrics.risk_score }}%</h3>
            <p class="text-sm opacity-90">Security Risk Score</p>
        </div>
        
        <div class="bg-gradient-to-br from-{% if summary.sentry_metrics.projects_with_errors > 0 %}uog-rust to-orange-600{% else %}uog-leaf to-green-600{% endif %} text-white p-6 rounded-lg text-center print-avoid-break">
            <h3 class="text-3xl font-bold mb-2">{{ summary.sentry_metrics.projects_with_sentry }}</h3>
            <p class="text-sm opacity-90">Projects with Sentry</p>
        </div>
        
        <div class="bg-gradient-to-br from-{% if summary.sentry_metrics.total_sentry_issues > 0 %}uog-burgundy to-red-700{% else %}uog-leaf to-green-600{% endif %} text-white p-6 rounded-lg text-center print-avoid-break">
            <h3 class="text-3xl font-bold mb-2">{{ summary.sentry_metrics.total_sentry_issues }}</h3>
            <p class="text-sm opacity-90">Sentry Issues (30d)</p>
        </div>
    </div>
    
    {% if llm_summary %}
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-8 rounded-xl border border-blue-200">
        <h3 class="text-xl font-bold text-uog-blue mb-4">Strategic Analysis</h3>
        <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed">
            {{ llm_summary | markdown | safe }}
        </div>
    </div>
    {% endif %}
</div>

<!-- Individual Project Sections -->
{% for repo_url, project in projects.items() %}
{% if project.success %}
<div class="mb-16 print-page-break" id="project-{{ loop.index }}">
    <!-- Project Header -->
    <div class="bg-gradient-to-r from-uog-blue to-uog-sky text-white p-8 rounded-xl mb-8 print-avoid-break">
        <h2 class="text-3xl font-bold mb-2">{{ project.name }}</h2>
        <div class="flex flex-wrap items-center space-x-6 text-sm opacity-90">
            <span><strong>Owner:</strong> {{ project.owner }}</span>
            <span><strong>Language:</strong> {{ project.primary_language | title if project.primary_language else 'Unknown' }}</span>
            <span><strong>URL:</strong> <a href="{{ project.url }}" target="_blank" class="underline hover:text-blue-200">{{ project.url }}</a></span>
        </div>
    </div>

    <!-- Project Executive Summary -->
    {% if project.llm_project_summary %}
    <div class="bg-gradient-to-r from-uog-light-slate to-gray-50 p-6 rounded-xl border-l-4 border-uog-blue mb-6 print-avoid-break">
        <h3 class="text-xl font-bold text-uog-slate mb-4 flex items-center">
            <span class="mr-3">📋</span>
            Project Summary
        </h3>
        <div class="prose max-w-none text-gray-700">
            {{ project.llm_project_summary | markdown | safe }}
        </div>
    </div>
    {% endif %}

    <!-- Project Overview -->
    <div class="mb-6">
        <h3 class="text-2xl font-bold text-uog-slate mb-4 border-l-4 border-uog-blue pl-4">
            📊 Project Overview
        </h3>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-lg text-center border border-gray-200 print-avoid-break">
                <div class="text-2xl font-bold text-uog-blue mb-1">{{ project.github_metadata.stars | default(0) }}</div>
                <div class="text-xs text-gray-600">Stars</div>
            </div>
            <div class="bg-white p-4 rounded-lg text-center border border-gray-200 print-avoid-break">
                <div class="text-2xl font-bold text-uog-blue mb-1">{{ project.github_metadata.forks | default(0) }}</div>
                <div class="text-xs text-gray-600">Forks</div>
            </div>
            <div class="bg-white p-4 rounded-lg text-center border border-gray-200 print-avoid-break">
                <div class="text-2xl font-bold text-uog-blue mb-1">{{ project.vulnerability_summary.total_dependencies | default(0) }}</div>
                <div class="text-xs text-gray-600">Dependencies</div>
            </div>
            <div class="bg-white p-4 rounded-lg text-center border border-gray-200 print-avoid-break">
                <div class="text-2xl font-bold {% if project.vulnerability_summary.vulnerable_packages > 0 %}text-uog-burgundy{% else %}text-uog-leaf{% endif %} mb-1">{{ project.vulnerability_summary.vulnerable_packages | default(0) }}</div>
                <div class="text-xs text-gray-600">Vulnerabilities</div>
            </div>
        </div>
    </div>

    <!-- Technology Stack -->
    <div class="mb-6">
        <h3 class="text-2xl font-bold text-uog-slate mb-4 border-l-4 border-uog-blue pl-4">
            🔧 Technology Stack
        </h3>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
                <h4 class="text-lg font-semibold text-uog-slate mb-3">Primary Language</h4>
                <div class="space-y-2">
                    <p class="text-lg font-medium text-uog-blue">{{ project.primary_language | title if project.primary_language else 'Unknown' }}</p>
                    {% if project.language_details[project.primary_language] %}
                        {% set lang_data = project.language_details[project.primary_language] %}
                        {% if lang_data.version %}
                            <p class="text-gray-600"><span class="font-medium">Version:</span> {{ lang_data.version }}</p>
                        {% endif %}
                        {% if lang_data.frameworks %}
                            <div class="mt-3">
                                <p class="font-medium text-gray-700 mb-2">Frameworks:</p>
                                <div class="space-y-1">
                                {% for framework, info in lang_data.frameworks.items() %}
                                    <div class="flex items-center justify-between bg-gray-100 px-3 py-1 rounded text-sm">
                                        <span>{{ framework | title }}</span>
                                        {% if info.version != 'unknown' %}
                                            <span class="text-xs bg-uog-blue text-white px-2 py-1 rounded">v{{ info.version }}</span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
                <h4 class="text-lg font-semibold text-uog-slate mb-3">Project Information</h4>
                <div class="space-y-3">
                    {% if project.github_metadata.license %}
                        <p><span class="font-medium text-gray-700">License:</span> 
                           <span class="inline-block bg-green-100 text-uog-leaf px-2 py-1 rounded text-sm">{{ project.github_metadata.license }}</span>
                        </p>
                    {% endif %}
                    {% if project.github_metadata.description %}
                        <p class="text-sm"><span class="font-medium text-gray-700">Description:</span> {{ project.github_metadata.description }}</p>
                    {% endif %}
                    {% if project.github_metadata.created_at %}
                        <p class="text-sm"><span class="font-medium text-gray-700">Created:</span> {{ project.github_metadata.created_at }}</p>
                    {% endif %}
                    {% if project.github_metadata.updated_at %}
                        <p class="text-sm"><span class="font-medium text-gray-700">Last Updated:</span> {{ project.github_metadata.updated_at }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="mb-6">
        <h3 class="text-2xl font-bold text-uog-slate mb-4 border-l-4 border-uog-blue pl-4">
            📈 Recent Activity (Past 30 Days)
        </h3>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
                <h4 class="text-lg font-semibold text-uog-slate mb-4 flex items-center">
                    <span class="mr-2">👥</span>
                    Development Activity
                </h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="text-gray-600">Commits</span>
                        <span class="font-semibold text-uog-blue">{{ project.github_commits.past_month.total | default(0) }}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="text-gray-600">Contributors</span>
                        <span class="font-semibold text-uog-blue">{{ project.github_commits.past_month.unique_authors | default(0) }}</span>
                    </div>
                    {% if project.github_commits.top_contributors %}
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">Top Contributor</p>
                            <p class="font-medium text-uog-blue">{{ project.github_commits.top_contributors[0].name }}</p>
                            <p class="text-xs text-gray-500">{{ project.github_commits.top_contributors[0].commits }} commits</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
                <h4 class="text-lg font-semibold text-uog-slate mb-4 flex items-center">
                    <span class="mr-2">🎯</span>
                    Issue Management
                </h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="text-gray-600">Issues Created</span>
                        <span class="font-semibold text-uog-blue">{{ project.github_issues.past_month.created | default(0) }}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="text-gray-600">Issues Resolved</span>
                        <span class="font-semibold text-uog-leaf">{{ project.github_issues.past_month.resolved | default(0) }}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-600">Resolution Rate</span>
                        <span class="font-semibold {% if project.github_issues.resolution_rate >= 80 %}text-uog-leaf{% elif project.github_issues.resolution_rate >= 50 %}text-uog-rust{% else %}text-uog-burgundy{% endif %}">
                            {{ project.github_issues.resolution_rate | default(0) }}%
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sentry Error Tracking -->
    {% if project.sentry_enabled %}
    <div class="mb-6">
        <h3 class="text-2xl font-bold text-uog-slate mb-4 border-l-4 border-uog-blue pl-4">
            🔥 Error Tracking (Sentry)
        </h3>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
                <h4 class="text-lg font-semibold text-uog-slate mb-4">Error Statistics</h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="text-gray-600">Total Issues</span>
                        <span class="font-semibold {% if project.sentry_issues.past_month.total > 0 %}text-uog-rust{% else %}text-uog-leaf{% endif %}">
                            {{ project.sentry_issues.past_month.total | default(0) }}
                        </span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="text-gray-600">Resolved Issues</span>
                        <span class="font-semibold text-uog-leaf">{{ project.sentry_issues.past_month.resolved | default(0) }}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="text-gray-600">Unresolved Issues</span>
                        <span class="font-semibold {% if project.sentry_issues.past_month.unresolved > 0 %}text-uog-rust{% else %}text-uog-leaf{% endif %}">
                            {{ project.sentry_issues.past_month.unresolved | default(0) }}
                        </span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-600">Event Volume</span>
                        <span class="font-semibold text-uog-blue">{{ project.sentry_issues.events_count | default(0) }}</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
                <h4 class="text-lg font-semibold text-uog-slate mb-4">Resolution Metrics</h4>
                {% if project.sentry_issues.avg_resolution_time.days > 0 %}
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Average Resolution Time</p>
                        <p class="text-2xl font-bold text-uog-blue">{{ project.sentry_issues.avg_resolution_time.days }} days</p>
                    </div>
                {% else %}
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Average Resolution Time</p>
                        <p class="text-lg font-medium text-gray-400">N/A</p>
                    </div>
                {% endif %}
                
                {% if project.sentry_projects %}
                    <div>
                        <p class="font-medium text-gray-700 mb-3">Sentry Projects:</p>
                        <div class="space-y-2">
                        {% for sentry_project in project.sentry_projects %}
                            <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded">
                                <span class="text-gray-700 text-sm">{{ sentry_project.name }}</span>
                                {% if sentry_project.platform != 'unknown' %}
                                    <span class="text-xs bg-uog-leaf text-white px-2 py-1 rounded">{{ sentry_project.platform }}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Security Analysis -->
    <div class="mb-6">
        <h3 class="text-2xl font-bold text-uog-slate mb-4 border-l-4 border-uog-blue pl-4">
            🛡️ Security Analysis
        </h3>
        
        {% if project.vulnerabilities %}
            <div class="space-y-3">
                {% for vuln in project.vulnerabilities[:5] %}
                    <div class="bg-white border-l-4 {% if vuln.vulnerability.severity == 'high' %}border-uog-burgundy bg-red-50{% elif vuln.vulnerability.severity == 'medium' %}border-uog-rust bg-orange-50{% else %}border-yellow-400 bg-yellow-50{% endif %} p-4 rounded-r-xl print-avoid-break">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-semibold text-gray-800">{{ vuln.package }} v{{ vuln.version }}</h5>
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium
                                {% if vuln.vulnerability.severity == 'high' %}bg-red-100 text-uog-burgundy
                                {% elif vuln.vulnerability.severity == 'medium' %}bg-orange-100 text-uog-rust
                                {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                                {{ vuln.vulnerability.severity | upper }}
                            </span>
                        </div>
                        <p class="text-gray-700 text-sm">{{ vuln.vulnerability.summary }}</p>
                    </div>
                {% endfor %}
                {% if project.vulnerabilities|length > 5 %}
                    <p class="text-sm text-gray-500 italic text-center py-2">... and {{ project.vulnerabilities|length - 5 }} more vulnerabilities</p>
                {% endif %}
            </div>
        {% else %}
            <div class="bg-green-50 border border-green-200 rounded-xl p-6 text-center">
                <div class="text-2xl mb-2">✅</div>
                <p class="font-semibold text-uog-leaf">No known security vulnerabilities found</p>
            </div>
        {% endif %}
    </div>

    <!-- Back to top link -->
    <div class="text-center mt-8 mb-4 no-print">
        <a href="#top" class="inline-flex items-center px-4 py-2 bg-uog-blue text-white rounded-lg hover:bg-uog-sky transition-colors duration-200">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
            </svg>
            Back to Top
        </a>
    </div>
</div>
{% endif %}
{% endfor %}
{% endblock %}

{% block footer_content %}
Generated by Code Reporter on {{ generated_at }}
<br>
This combined report includes {{ summary.successful_analyses }} project{{ 's' if summary.successful_analyses != 1 else '' }}
{% endblock %}