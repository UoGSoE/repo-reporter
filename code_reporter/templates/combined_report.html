<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Project Report - Code Analysis</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
        
        /* Header Styles */
        .header { text-align: center; border-bottom: 3px solid #007acc; padding-bottom: 30px; margin-bottom: 40px; }
        .header h1 { color: #007acc; margin: 0; font-size: 3em; }
        .header .subtitle { color: #666; font-size: 1.2em; margin-top: 10px; }
        
        /* Navigation Index */
        .nav-index { background: #f8f9fa; padding: 30px; border-radius: 8px; margin: 30px 0; border-left: 5px solid #007acc; }
        .nav-index h2 { margin-top: 0; color: #007acc; }
        .nav-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .nav-item { background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #007acc; }
        .nav-item a { text-decoration: none; color: #007acc; font-weight: bold; }
        .nav-item a:hover { color: #0056b3; }
        .nav-item .meta { font-size: 0.9em; color: #666; margin-top: 5px; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .status-secure { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-danger { background: #f8d7da; color: #721c24; }
        
        /* Executive Summary Styles */
        .executive-summary { background: #f8f9fa; padding: 30px; border-radius: 8px; margin: 30px 0; border-left: 5px solid #007acc; }
        .kpi-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 20px; margin: 30px 0; }
        @media (max-width: 1400px) { .kpi-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 900px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .kpi-grid { grid-template-columns: 1fr; } }
        .kpi-card { background: linear-gradient(135deg, #007acc, #0056b3); color: white; padding: 30px; border-radius: 8px; text-align: center; }
        .kpi-card h3 { margin: 0; font-size: 2.5em; }
        .kpi-card p { margin: 10px 0 0 0; font-size: 1.1em; opacity: 0.9; }
        .risk-card { background: linear-gradient(135deg, #dc3545, #b02a37); }
        .success-card { background: linear-gradient(135deg, #28a745, #1e7e34); }
        .warning-card { background: linear-gradient(135deg, #fd7e14, #e55100); }
        .llm-summary { line-height: 1.6; }
        .llm-summary p { margin: 0 0 15px 0; text-align: justify; }
        
        /* Project Sections */
        .project-section { margin: 60px 0; padding: 40px 0; border-top: 2px solid #eee; }
        .project-section:first-of-type { border-top: none; }
        .project-header { background: linear-gradient(135deg, #007acc, #0056b3); color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px; }
        .project-header h2 { margin: 0; font-size: 2.5em; }
        .project-header .meta { opacity: 0.9; margin-top: 10px; font-size: 1.1em; }
        
        /* Content Styles */
        .section { margin: 30px 0; }
        .section h3 { color: #333; border-left: 4px solid #007acc; padding-left: 15px; font-size: 1.5em; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f9f9f9; padding: 20px; border-radius: 6px; border-left: 4px solid #007acc; }
        .vulnerability { background: #fff5f5; border-left-color: #dc3545; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .vulnerability.high { background: #fff0f0; border-left-color: #dc3545; }
        .vulnerability.medium { background: #fff8f0; border-left-color: #fd7e14; }
        .vulnerability.low { background: #f0f8f0; border-left-color: #28a745; }
        .secure { color: #28a745; font-weight: bold; }
        .warning { color: #dc3545; font-weight: bold; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold; }
        .badge.success { background: #d4edda; color: #155724; }
        .badge.danger { background: #f8d7da; color: #721c24; }
        .badge.warning { background: #fff3cd; color: #856404; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-item { text-align: center; padding: 20px; background: #f8f9fa; border-radius: 6px; }
        .stat-number { font-size: 2em; font-weight: bold; color: #007acc; }
        
        /* Back to top */
        .back-to-top { position: fixed; bottom: 20px; right: 20px; background: #007acc; color: white; padding: 10px 15px; border-radius: 50px; text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .back-to-top:hover { background: #0056b3; color: white; }
        
        /* Print styles */
        @media print {
            .back-to-top { display: none; }
            .project-section { page-break-before: always; }
            .project-section:first-of-type { page-break-before: auto; }
        }
        
        .footer { margin-top: 50px; padding-top: 30px; border-top: 1px solid #eee; color: #666; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header" id="top">
            <h1>📊 Complete Project Analysis</h1>
            <div class="subtitle">Combined Report for All Repositories</div>
            <div class="subtitle">Generated on {{ generated_at }}</div>
        </div>

        <!-- Navigation Index -->
        <div class="nav-index">
            <h2>📋 Project Index</h2>
            <p>Click on any project below to jump to its detailed analysis:</p>
            <div class="nav-grid">
                {% for repo_url, project in projects.items() %}
                {% if project.success %}
                <div class="nav-item">
                    <a href="#project-{{ loop.index }}">{{ project.name }}</a>
                    <div class="meta">
                        {{ project.primary_language | title if project.primary_language else 'Unknown' }} • 
                        {% if project.vulnerability_summary.vulnerable_packages > 0 %}
                            <span class="status-badge status-danger">{{ project.vulnerability_summary.vulnerable_packages }} vulnerabilities</span>
                        {% else %}
                            <span class="status-badge status-secure">Secure</span>
                        {% endif %}
                        {% if project.sentry_enabled and project.sentry_issues.past_month.total > 0 %}
                            • <span class="status-badge status-warning">{{ project.sentry_issues.past_month.total }} Sentry issues</span>
                        {% elif project.sentry_enabled %}
                            • <span class="status-badge status-secure">No errors</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Executive Summary Section -->
        <div class="executive-summary">
            <h2>📋 Executive Summary</h2>
            
            <!-- KPIs -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <h3>{{ summary.successful_analyses }}</h3>
                    <p>Projects Analyzed</p>
                </div>
                <div class="kpi-card success-card">
                    <h3>{{ summary.total_dependencies }}</h3>
                    <p>Total Dependencies</p>
                </div>
                <div class="kpi-card {% if risk_metrics.vulnerable_projects > 0 %}risk-card{% else %}success-card{% endif %}">
                    <h3>{{ risk_metrics.vulnerable_projects }}</h3>
                    <p>Projects with Vulnerabilities</p>
                </div>
                <div class="kpi-card warning-card">
                    <h3>{{ risk_metrics.risk_score }}%</h3>
                    <p>Security Risk Score</p>
                </div>
                <div class="kpi-card {% if summary.sentry_metrics.projects_with_errors > 0 %}warning-card{% else %}success-card{% endif %}">
                    <h3>{{ summary.sentry_metrics.projects_with_sentry }}</h3>
                    <p>Projects with Sentry</p>
                </div>
                <div class="kpi-card {% if summary.sentry_metrics.total_sentry_issues > 0 %}risk-card{% else %}success-card{% endif %}">
                    <h3>{{ summary.sentry_metrics.total_sentry_issues }}</h3>
                    <p>Sentry Issues (30d)</p>
                </div>
            </div>
            
            {% if llm_summary %}
            <div class="llm-summary">
                {{ llm_summary | markdown | safe }}
            </div>
            {% endif %}
        </div>

        <!-- Individual Project Sections -->
        {% for repo_url, project in projects.items() %}
        {% if project.success %}
        <div class="project-section" id="project-{{ loop.index }}">
            <div class="project-header">
                <h2>{{ project.name }}</h2>
                <div class="meta">
                    <strong>Owner:</strong> {{ project.owner }} | 
                    <strong>Language:</strong> {{ project.primary_language | title if project.primary_language else 'Unknown' }} |
                    <strong>URL:</strong> <a href="{{ project.url }}" target="_blank" style="color: white;">{{ project.url }}</a>
                </div>
            </div>

            <!-- Project Executive Summary -->
            {% if project.llm_project_summary %}
            <div class="section">
                <h3>📋 Project Summary</h3>
                <div class="card">
                    {{ project.llm_project_summary | markdown | safe }}
                </div>
            </div>
            {% endif %}

            <!-- Project Overview -->
            <div class="section">
                <h3>📊 Project Overview</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">{{ project.github_metadata.stars | default(0) }}</div>
                        <div>Stars</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ project.github_metadata.forks | default(0) }}</div>
                        <div>Forks</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ project.vulnerability_summary.total_dependencies | default(0) }}</div>
                        <div>Dependencies</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number {% if project.vulnerability_summary.vulnerable_packages > 0 %}warning{% else %}secure{% endif %}">{{ project.vulnerability_summary.vulnerable_packages | default(0) }}</div>
                        <div>Vulnerabilities</div>
                    </div>
                </div>
            </div>

            <!-- Technology Stack -->
            <div class="section">
                <h3>🔧 Technology Stack</h3>
                <div class="grid">
                    <div class="card">
                        <h4>Primary Language</h4>
                        <p><strong>{{ project.primary_language | title if project.primary_language else 'Unknown' }}</strong></p>
                        {% if project.language_details[project.primary_language] %}
                            {% set lang_data = project.language_details[project.primary_language] %}
                            {% if lang_data.version %}
                                <p>Version: {{ lang_data.version }}</p>
                            {% endif %}
                            {% if lang_data.frameworks %}
                                <p><strong>Frameworks:</strong></p>
                                <ul>
                                {% for framework, info in lang_data.frameworks.items() %}
                                    <li>{{ framework | title }} 
                                        {% if info.version != 'unknown' %}(v{{ info.version }}){% endif %}
                                    </li>
                                {% endfor %}
                                </ul>
                            {% endif %}
                        {% endif %}
                    </div>
                    <div class="card">
                        <h4>Project Information</h4>
                        {% if project.github_metadata.license %}
                            <p><strong>License:</strong> {{ project.github_metadata.license }}</p>
                        {% endif %}
                        {% if project.github_metadata.description %}
                            <p><strong>Description:</strong> {{ project.github_metadata.description }}</p>
                        {% endif %}
                        <p><strong>Created:</strong> {{ project.github_metadata.created_at | default('Unknown') }}</p>
                        <p><strong>Last Updated:</strong> {{ project.github_metadata.updated_at | default('Unknown') }}</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="section">
                <h3>📈 Recent Activity (Past 30 Days)</h3>
                <div class="grid">
                    <div class="card">
                        <h4>Development Activity</h4>
                        <p><strong>Commits:</strong> {{ project.github_commits.past_month.total | default(0) }}</p>
                        <p><strong>Contributors:</strong> {{ project.github_commits.past_month.unique_authors | default(0) }}</p>
                        {% if project.github_commits.top_contributors %}
                            <p><strong>Top Contributor:</strong> {{ project.github_commits.top_contributors[0].name }} ({{ project.github_commits.top_contributors[0].commits }} commits)</p>
                        {% endif %}
                    </div>
                    <div class="card">
                        <h4>Issue Management</h4>
                        <p><strong>Issues Created:</strong> {{ project.github_issues.past_month.created | default(0) }}</p>
                        <p><strong>Issues Resolved:</strong> {{ project.github_issues.past_month.resolved | default(0) }}</p>
                        <p><strong>Resolution Rate:</strong> {{ project.github_issues.resolution_rate | default(0) }}%</p>
                    </div>
                </div>
            </div>

            <!-- Sentry Error Tracking -->
            {% if project.sentry_enabled %}
            <div class="section">
                <h3>🔥 Error Tracking (Sentry)</h3>
                <div class="grid">
                    <div class="card">
                        <h4>Error Statistics</h4>
                        <p><strong>Total Issues:</strong> <span class="{% if project.sentry_issues.past_month.total > 0 %}warning{% else %}secure{% endif %}">{{ project.sentry_issues.past_month.total | default(0) }}</span></p>
                        <p><strong>Resolved Issues:</strong> {{ project.sentry_issues.past_month.resolved | default(0) }}</p>
                        <p><strong>Unresolved Issues:</strong> <span class="{% if project.sentry_issues.past_month.unresolved > 0 %}warning{% else %}secure{% endif %}">{{ project.sentry_issues.past_month.unresolved | default(0) }}</span></p>
                        <p><strong>Event Volume:</strong> {{ project.sentry_issues.events_count | default(0) }}</p>
                    </div>
                    <div class="card">
                        <h4>Resolution Metrics</h4>
                        {% if project.sentry_issues.avg_resolution_time.days > 0 %}
                            <p><strong>Avg Resolution Time:</strong> {{ project.sentry_issues.avg_resolution_time.days }} days</p>
                        {% else %}
                            <p><strong>Avg Resolution Time:</strong> <span class="secure">N/A</span></p>
                        {% endif %}
                        
                        {% if project.sentry_projects %}
                            <p><strong>Sentry Projects:</strong></p>
                            <ul>
                            {% for sentry_project in project.sentry_projects %}
                                <li>{{ sentry_project.name }}
                                    {% if sentry_project.platform != 'unknown' %}
                                        <span class="badge success">{{ sentry_project.platform }}</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Security Analysis -->
            <div class="section">
                <h3>🛡️ Security Analysis</h3>
                {% if project.vulnerabilities %}
                    {% for vuln in project.vulnerabilities[:5] %}
                        <div class="vulnerability {{ vuln.vulnerability.severity }}">
                            <h4>{{ vuln.package }} v{{ vuln.version }}</h4>
                            <p><strong>Severity:</strong> 
                                <span class="badge {% if vuln.vulnerability.severity == 'high' %}danger{% elif vuln.vulnerability.severity == 'medium' %}warning{% else %}success{% endif %}">
                                    {{ vuln.vulnerability.severity | upper }}
                                </span>
                            </p>
                            <p>{{ vuln.vulnerability.summary }}</p>
                        </div>
                    {% endfor %}
                    {% if project.vulnerabilities|length > 5 %}
                        <p><em>... and {{ project.vulnerabilities|length - 5 }} more vulnerabilities</em></p>
                    {% endif %}
                {% else %}
                    <p class="secure">✅ No known security vulnerabilities found</p>
                {% endif %}
            </div>

            <div style="text-align: center; margin: 30px 0;">
                <a href="#top" class="badge success" style="text-decoration: none; padding: 10px 20px;">↑ Back to Top</a>
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <div class="footer">
            <p>Generated by Code Reporter on {{ generated_at }}</p>
            <p>This combined report includes {{ summary.successful_analyses }} project{{ 's' if summary.successful_analyses != 1 else '' }}</p>
        </div>
    </div>

    <!-- Floating back to top button -->
    <a href="#top" class="back-to-top" title="Back to Top">↑</a>
</body>
</html>