{% extends "base.html" %}

{% block title %}{{ project.name }} - Code Analysis Report{% endblock %}

{% block header_title %}{{ project.name }}{% endblock %}
{% block header_subtitle %}{{ project.owner }}{% endblock %}
{% block header_meta %}
<div class="flex justify-center items-center space-x-4 text-sm">
    <span>🔗 <a href="{{ project.url }}" target="_blank" class="underline hover:text-blue-200">{{ project.url }}</a></span>
    <span>📅 Generated: {{ generated_at }}</span>
</div>
{% endblock %}

{% block content %}
<!-- Executive Summary -->
{% if project.llm_project_summary %}
<div class="bg-gradient-to-r from-uog-light-slate to-gray-50 p-8 rounded-xl border-l-4 border-uog-blue mb-8 print-avoid-break">
    <h2 class="text-2xl font-bold text-uog-slate mb-6 flex items-center">
        <span class="mr-3">📋</span>
        Executive Summary
    </h2>
    <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed">
        {{ project.llm_project_summary | markdown | safe }}
    </div>
</div>
{% endif %}

<!-- Overview Section -->
<div class="mb-8">
    <h2 class="text-3xl font-bold text-uog-slate mb-6 border-l-4 border-uog-blue pl-4">
        📊 Project Overview
    </h2>
    
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-lg text-center border border-gray-200 print-avoid-break">
            <div class="text-3xl font-bold text-uog-blue mb-2">{{ project.github_metadata.stars | default(0) }}</div>
            <div class="text-sm text-gray-600">Stars</div>
        </div>
        
        <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-lg text-center border border-gray-200 print-avoid-break">
            <div class="text-3xl font-bold text-uog-blue mb-2">{{ project.github_metadata.forks | default(0) }}</div>
            <div class="text-sm text-gray-600">Forks</div>
        </div>
        
        <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-lg text-center border border-gray-200 print-avoid-break">
            <div class="text-3xl font-bold text-uog-blue mb-2">{{ dependency_count }}</div>
            <div class="text-sm text-gray-600">Dependencies</div>
        </div>
        
        <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-lg text-center border border-gray-200 print-avoid-break">
            <div class="text-3xl font-bold {% if vulnerability_count > 0 %}text-uog-burgundy{% else %}text-uog-leaf{% endif %} mb-2">{{ vulnerability_count }}</div>
            <div class="text-sm text-gray-600">Vulnerabilities</div>
        </div>
    </div>
</div>

<!-- Technology Stack -->
<div class="mb-8">
    <h2 class="text-3xl font-bold text-uog-slate mb-6 border-l-4 border-uog-blue pl-4">
        🔧 Technology Stack
    </h2>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
            <h3 class="text-xl font-semibold text-uog-slate mb-4">Primary Language</h3>
            <div class="space-y-3">
                <p class="text-lg font-medium text-uog-blue">{{ project.primary_language | title }}</p>
                {% if project.language_details[project.primary_language] %}
                    {% set lang_data = project.language_details[project.primary_language] %}
                    {% if lang_data.version %}
                        <p class="text-gray-600"><span class="font-medium">Version:</span> {{ lang_data.version }}</p>
                    {% endif %}
                    {% if lang_data.frameworks %}
                        <div>
                            <p class="font-medium text-gray-700 mb-2">Frameworks:</p>
                            <div class="space-y-1">
                            {% for framework, info in lang_data.frameworks.items() %}
                                <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded">
                                    <span class="text-gray-700">{{ framework | title }}</span>
                                    {% if info.version != 'unknown' %}
                                        <span class="text-xs bg-uog-blue text-white px-2 py-1 rounded">v{{ info.version }}</span>
                                    {% endif %}
                                </div>
                            {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
            <h3 class="text-xl font-semibold text-uog-slate mb-4">Repository Information</h3>
            <div class="space-y-3">
                {% if project.github_metadata.license %}
                    <p><span class="font-medium text-gray-700">License:</span> 
                       <span class="inline-block bg-green-100 text-uog-leaf px-2 py-1 rounded text-sm">{{ project.github_metadata.license }}</span>
                    </p>
                {% endif %}
                {% if project.github_metadata.description %}
                    <p><span class="font-medium text-gray-700">Description:</span> {{ project.github_metadata.description }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Dependency License Analysis -->
{% if dependency_license_chart %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-uog-slate mb-6 border-l-4 border-uog-blue pl-4">
        📄 Dependency Licenses
    </h2>
    <div class="bg-white p-6 rounded-xl shadow-md print-avoid-break">
        <h3 class="text-xl font-semibold text-uog-slate mb-4 border-b pb-2">License Distribution of Dependencies</h3>
        <div class="min-h-[400px]">
            {{ dependency_license_chart | safe }}
        </div>
    </div>
</div>
{% endif %}

<!-- Security Analysis -->
<div class="mb-8">
    <h2 class="text-3xl font-bold text-uog-slate mb-6 border-l-4 border-uog-blue pl-4">
        🛡️ Security Analysis
    </h2>
    
    {% if has_vulnerabilities %}
        <div class="bg-red-50 border border-red-200 rounded-xl p-6 mb-6">
            <div class="flex items-center mb-4">
                <span class="text-2xl mr-3">⚠️</span>
                <h3 class="text-xl font-semibold text-uog-burgundy">{{ vulnerability_count }} Security Vulnerabilities Found</h3>
            </div>
        </div>
        
        <div class="space-y-4">
            {% for vuln in project.vulnerabilities[:10] %}
                <div class="bg-white border-l-4 {% if 'high' in vuln.vulnerability.severity.lower() %}border-uog-burgundy bg-red-50{% elif 'medium' in vuln.vulnerability.severity.lower() %}border-uog-rust bg-orange-50{% else %}border-yellow-400 bg-yellow-50{% endif %} p-6 rounded-r-xl print-avoid-break">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="text-lg font-semibold text-gray-800">{{ vuln.package }} v{{ vuln.version }}</h4>
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-medium
                            {% if 'high' in vuln.vulnerability.severity.lower() %}bg-red-100 text-uog-burgundy
                            {% elif 'medium' in vuln.vulnerability.severity.lower() %}bg-orange-100 text-uog-rust
                            {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                            {{ vuln.vulnerability.severity | upper }}
                        </span>
                    </div>
                    <p class="text-gray-700 mb-2">{{ vuln.vulnerability.summary }}</p>
                    {% if vuln.vulnerability.id %}
                        <p class="text-sm text-gray-500">
                            <span class="font-medium">ID:</span> 
                            <code class="bg-gray-100 px-2 py-1 rounded text-xs">{{ vuln.vulnerability.id }}</code>
                        </p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="bg-green-50 border border-green-200 rounded-xl p-8 text-center">
            <div class="text-4xl mb-4">✅</div>
            <h3 class="text-xl font-semibold text-uog-leaf mb-2">No Security Vulnerabilities Found</h3>
            <p class="text-gray-600">All dependencies have been scanned and no known vulnerabilities were detected.</p>
        </div>
    {% endif %}
</div>

<!-- Activity Metrics -->
<div class="mb-8">
    <h2 class="text-3xl font-bold text-uog-slate mb-6 border-l-4 border-uog-blue pl-4">
        📈 Recent Activity (Past 30 Days)
    </h2>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
            <h3 class="text-xl font-semibold text-uog-slate mb-4 flex items-center">
                <span class="mr-2">👥</span>
                Development Activity
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-600">Commits</span>
                    <span class="font-semibold text-uog-blue">{{ project.github_commits.past_month.total | default(0) }}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-600">Contributors</span>
                    <span class="font-semibold text-uog-blue">{{ project.github_commits.past_month.unique_authors | default(0) }}</span>
                </div>
                {% if project.github_commits.top_contributors %}
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-600 mb-1">Top Contributor</p>
                        <p class="font-medium text-uog-blue">{{ project.github_commits.top_contributors[0].name }}</p>
                        <p class="text-xs text-gray-500">{{ project.github_commits.top_contributors[0].commits }} commits</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
            <h3 class="text-xl font-semibold text-uog-slate mb-4 flex items-center">
                <span class="mr-2">🎯</span>
                Issue Management
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-600">Issues Created</span>
                    <span class="font-semibold text-uog-blue">{{ project.github_issues.past_month.created | default(0) }}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-600">Issues Resolved</span>
                    <span class="font-semibold text-uog-leaf">{{ project.github_issues.past_month.resolved | default(0) }}</span>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-gray-600">Resolution Rate</span>
                    <span class="font-semibold {% if project.github_issues.resolution_rate >= 80 %}text-uog-leaf{% elif project.github_issues.resolution_rate >= 50 %}text-uog-rust{% else %}text-uog-burgundy{% endif %}">
                        {{ project.github_issues.resolution_rate | default(0) }}%
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sentry Error Tracking -->
{% if project.sentry_enabled %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-uog-slate mb-6 border-l-4 border-uog-blue pl-4">
        🔥 Error Tracking (Sentry)
    </h2>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
            <h3 class="text-xl font-semibold text-uog-slate mb-4">Error Statistics</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-600">Total Issues</span>
                    <span class="font-semibold {% if project.sentry_issues.past_month.total > 0 %}text-uog-rust{% else %}text-uog-leaf{% endif %}">
                        {{ project.sentry_issues.past_month.total | default(0) }}
                    </span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-600">Resolved Issues</span>
                    <span class="font-semibold text-uog-leaf">{{ project.sentry_issues.past_month.resolved | default(0) }}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-600">Unresolved Issues</span>
                    <span class="font-semibold {% if project.sentry_issues.past_month.unresolved > 0 %}text-uog-rust{% else %}text-uog-leaf{% endif %}">
                        {{ project.sentry_issues.past_month.unresolved | default(0) }}
                    </span>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-gray-600">Event Volume</span>
                    <span class="font-semibold text-uog-blue">{{ project.sentry_issues.events_count | default(0) }}</span>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-xl border-l-4 border-uog-blue print-avoid-break">
            <h3 class="text-xl font-semibold text-uog-slate mb-4">Resolution Metrics</h3>
            
            {% if project.sentry_issues.avg_resolution_time.days > 0 %}
                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Average Resolution Time</p>
                    <p class="text-2xl font-bold text-uog-blue">{{ project.sentry_issues.avg_resolution_time.days }} days</p>
                </div>
            {% else %}
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Average Resolution Time</p>
                    <p class="text-lg font-medium text-gray-400">N/A</p>
                </div>
            {% endif %}
            
            {% if project.sentry_projects %}
                <div>
                    <p class="font-medium text-gray-700 mb-3">Sentry Projects:</p>
                    <div class="space-y-2">
                    {% for sentry_project in project.sentry_projects %}
                        <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded">
                            <span class="text-gray-700">{{ sentry_project.name }}</span>
                            {% if sentry_project.platform != 'unknown' %}
                                <span class="text-xs bg-uog-leaf text-white px-2 py-1 rounded">{{ sentry_project.platform }}</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% else %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-uog-slate mb-6 border-l-4 border-uog-blue pl-4">
        🔥 Error Tracking
    </h2>
    
    <div class="bg-orange-50 border border-orange-200 rounded-xl p-6">
        <div class="flex items-center mb-3">
            <span class="text-2xl mr-3">⚠️</span>
            <h3 class="text-lg font-semibold text-uog-rust">Sentry Integration Not Configured</h3>
        </div>
        <p class="text-gray-700 mb-2">No matching Sentry projects found for error tracking analysis.</p>
        <p class="text-sm text-gray-600">To enable error tracking, configure SENTRY_AUTH_TOKEN and SENTRY_ORG_SLUG environment variables.</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block footer_content %}
Generated by Code Reporter on {{ generated_at }}
{% endblock %}